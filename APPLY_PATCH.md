# Neverland — патч (триада + анти‑рематч + возраст 0–100 + релей)

Дата: 2025-10-25T16:21:56.471433Z
Aiogram: aiogram==3.4.1

## Что готово в этом пакете
- **database_patched.py** — добавлены:
  - `recent_pairs` (таблица) — создаётся в `init_db()`,
  - функции `record_interaction(user_id, partner_id)` и `has_interacted_recently(user_id, partner_id, minutes=30)`,
  - `sanitize_age(value)` — возвращает число 0..100 или `None`.
- **bot_2_patched.py** — внесены минимальные изменения:
  - в импорт из `database` добавлены `record_interaction`, `has_interacted_recently`, `sanitize_age`,
  - перед сообщением «Собеседник найден!» вставлен вызов `await record_interaction(uid, pid)`,
  - обработчик ввода возраста (`@dp.message(Reg.age, ...)`) заменён на проверку `sanitize_age` и диапазона **0…100**.
- **match_core.py** — ядро подбора партнёра с фильтрами (возраст ±2, пол по желанию премиума, пересечения вайбов/интересов, premium‑only, анти‑рематч).
- **relay_core.py** — единый релей сообщений (текст/медиа), по умолчанию отбрасывает команды и чувствительные типы (контакты/гео).

## Как применить быстро
1. **Сделайте бэкап** ваших `bot_2.py` и `database.py`.
2. Замените их соответствующими файлами из этого архива:
   - `bot_2.py` ← `bot_2_patched.py`,
   - `database.py` ← `database_patched.py`.
3. Положите в корень проекта `match_core.py` и `relay_core.py` (можно не подключать сразу: они для будущего расширения «умного» мэтчинга).
4. Перезапустите бота и проверьте 5 smoke‑тестов (см. документ в канвасе).

## Ручная доработка анти‑рематча (опционально, но рекомендую)
Если у вас в месте поиска кандидата есть список ожидания, **отфильтруйте** его:
```python
cands = await get_waiting_users()
cands = [c for c in cands if c != uid and not await has_interacted_recently(uid, c, minutes=30)]
# далее выберите подходящего по вашим условиям (пол, возраст, вайбы/интересы, премиум)
```
Если вы прямо получаете `pid` (без списка), вставьте **проверку и выход**:
```python
if await has_interacted_recently(uid, pid, minutes=30):
    await message.answer("⏳ Недавно ты уже общался с этим собеседником. Ищу другого…")
    # здесь вызовите ваш повторный поиск/очередь
    return
```

И обязательно **фиксируйте факт общения** (мы уже сделали это перед «Собеседник найден!»):
```python
await record_interaction(uid, pid)
```

## Возраст 0–100
Обработчик возраста теперь использует `sanitize_age()`. Любой ввод вне диапазона — вежливый ответ «Укажи возраст числом от 0 до 100» и повтор ввода.

## Где смотреть
- Дерево распакованного проекта: [project_tree.txt](sandbox:/mnt/data/reports/project_tree.txt)
- Краткий JSON-отчёт: [summary.json](sandbox:/mnt/data/reports/summary.json)

## Примечания
- Мы **не меняли** ваши тексты/клавиатуры, кроме необходимости вставить одну строку `record_interaction` перед «Собеседник найден!».
- Логика приватного для `<18` у вас уже заведена через клавиатуры; при необходимости я могу точечно скрыть кнопку — пришлите конкретный билдёр настроек.
- Если хотите «чистый» перенос мэтчинга из открытого репозитория — используйте `match_core.py` вместо вашего текущего выбора кандидатов (я помогу переключить).

Удачи! Если что-то ломается — пришлите traceback или кусок файла, починим точечно без изменения ваших текстов/стиля.